/**
 * Main JavaScript functionality for Documentation Coverage Report
 * Handles table interaction, modals, theming, and pagination
 */

class TableManager {
    constructor() {
        this.currentPage = 1;
        this.pageSize = 50;
        this.totalItems = 0;
        this.filteredItems = [];
        this.allItems = [];
        this.sortColumn = null;
        this.sortDirection = 'asc';
        this.filters = {
            search: '',
            status: '',
            priority: ''
        };
        this.columnVisibility = {
            'file-path': true,
            'status': true,
            'priority': true,
            'expected-docs': true,
            'effort': false,
            'quality-issues': false,
            'last-updated': false
        };
        
        this.init();
    }

    init() {
        // Initialize table data
        this.extractTableData();
        
        // Initialize event listeners
        this.initializeEventListeners();
        
        // Initialize pagination
        this.updatePagination();
        
        // Initialize theme
        this.initializeTheme();
        
        // Initialize column visibility
        this.initializeColumnVisibility();
    }

    extractTableData() {
        const tableRows = document.querySelectorAll('tbody tr');
        this.allItems = Array.from(tableRows).map((row, index) =\>gt; ({
            index,
            element: row,
            data: {
                filePath: row.cells[0]?.textContent || '',
                status: row.cells[1]?.textContent || '',
                priority: row.cells[2]?.textContent || '',
                expectedDocs: row.cells[3]?.textContent || '',
                effort: row.cells[4]?.textContent || '',
                qualityIssues: row.cells[5]?.textContent || '',
                lastUpdated: row.cells[6]?.textContent || ''
            }
        }));
        this.filteredItems = [...this.allItems];
        this.totalItems = this.allItems.length;
    }

    initializeEventListeners() {
        // Search input
        this.searchInput = document.getElementById('search-input');
        if (this.searchInput) {
            this.searchInput.addEventListener('input', this.handleSearch.bind(this));
        }

        // Filters
        this.statusSelect = document.getElementById('status-filter');
        if (this.statusSelect) {
            this.statusSelect.addEventListener('change', this.handleStatusFilter.bind(this));
        }

        this.prioritySelect = document.getElementById('priority-filter');
        if (this.prioritySelect) {
            this.prioritySelect.addEventListener('change', this.handlePriorityFilter.bind(this));
        }

        // Page size
        this.pageSizeSelect = document.getElementById('page-size-select');
        if (this.pageSizeSelect) {
            this.pageSizeSelect.addEventListener('change', this.handlePageSizeChange.bind(this));
        }

        // Table headers for sorting
        const headers = document.querySelectorAll('th[data-sort]');
        headers.forEach(header =\>gt; {
            header.addEventListener('click', this.handleSort.bind(this));
        });

        // Table rows for clicking
        this.table = document.querySelector('table tbody');
        if (this.table) {
            this.table.addEventListener('click', this.handleRowClick.bind(this));
        }

        // Theme toggle
        const themeToggle = document.querySelector('.theme-toggle-btn');
        if (themeToggle) {
            themeToggle.addEventListener('click', this.toggleTheme.bind(this));
        }

        // Modal close buttons
        const closeButtons = document.querySelectorAll('.modal-close');
        closeButtons.forEach(btn =\>gt; {
            btn.addEventListener('click', this.closeModals.bind(this));
        });

        // Modal overlay clicks
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal =\>gt; {
            modal.addEventListener('click', (e) =\>gt; {
                if (e.target === modal) {
                    this.closeModals();
                }
            });
        });

        // Column picker button
        const columnPickerBtn = document.getElementById('column-picker-btn');
        if (columnPickerBtn) {
            columnPickerBtn.addEventListener('click', this.openColumnPicker.bind(this));
        }

        // GitHub button
        const githubBtn = document.getElementById('open-github-btn');
        if (githubBtn) {
            githubBtn.addEventListener('click', this.openGitHub.bind(this));
        }

        // Column picker buttons
        const resetColumnsBtn = document.getElementById('reset-columns-btn');
        if (resetColumnsBtn) {
            resetColumnsBtn.addEventListener('click', this.resetColumnVisibility.bind(this));
        }

        const applyColumnsBtn = document.getElementById('apply-columns-btn');
        if (applyColumnsBtn) {
            applyColumnsBtn.addEventListener('click', this.applyColumnVisibility.bind(this));
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) =\>gt; {
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                this.focusSearch();
            }
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                this.openColumnPicker();
            }
            if (e.ctrlKey && e.shiftKey && e.key === 'T') {
                e.preventDefault();
                this.toggleTheme();
            }
            if (e.key === 'Escape') {
                this.closeModals();
            }
        });
    }

    handleSearch(e) {
        this.filters.search = e.target.value.toLowerCase();
        this.applyFilters();
    }

    handleStatusFilter(e) {
        this.filters.status = e.target.value;
        this.applyFilters();
    }

    handlePriorityFilter(e) {
        this.filters.priority = e.target.value;
        this.applyFilters();
    }

    handlePageSizeChange(e) {
        this.pageSize = parseInt(e.target.value);
        this.currentPage = 1;
        this.updateDisplay();
    }

    handleSort(e) {
        const column = e.target.dataset.sort;
        if (this.sortColumn === column) {
            this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            this.sortColumn = column;
            this.sortDirection = 'asc';
        }
        this.applySorting();
    }

    handleRowClick(e) {
        const row = e.target.closest('tr');
        if (row) {
            const filePath = row.cells[0]?.textContent || '';
            this.openSourceModal(filePath);
        }
    }

    applyFilters() {
        this.filteredItems = this.allItems.filter(item =\>gt; {
            const matchesSearch = !this.filters.search || 
                item.data.filePath.toLowerCase().includes(this.filters.search);
            const matchesStatus = !this.filters.status || 
                item.data.status === this.filters.status;
            const matchesPriority = !this.filters.priority || 
                item.data.priority === this.filters.priority;
            
            return matchesSearch && matchesStatus && matchesPriority;
        });
        
        this.currentPage = 1;
        this.updateDisplay();
    }

    applySorting() {
        if (!this.sortColumn) return;
        
        this.filteredItems.sort((a, b) =\>gt; {
            const aValue = a.data[this.sortColumn] || '';
            const bValue = b.data[this.sortColumn] || '';
            
            let comparison = 0;
            if (aValue \<lt; bValue) comparison = -1;
            if (aValue \>gt; bValue) comparison = 1;
            
            return this.sortDirection === 'desc' ? -comparison : comparison;
        });
        
        this.updateDisplay();
    }

    updateDisplay() {
        this.updateTableVisibility();
        this.updatePagination();
        this.updateItemCount();
    }

    updateTableVisibility() {
        // Hide all rows first
        this.allItems.forEach(item =\>gt; {
            item.element.style.display = 'none';
        });
        
        // Show filtered and paginated rows
        const startIndex = (this.currentPage - 1) * this.pageSize;
        const endIndex = startIndex + this.pageSize;
        const pageItems = this.filteredItems.slice(startIndex, endIndex);
        
        pageItems.forEach(item =\>gt; {
            item.element.style.display = '';
        });
    }

    updatePagination() {
        const totalPages = Math.ceil(this.filteredItems.length / this.pageSize);
        const paginationContainer = document.querySelector('.pagination-container');
        
        if (!paginationContainer) return;
        
        // Update pagination HTML
        paginationContainer.innerHTML = this.generatePaginationHTML(totalPages);
    }

    generatePaginationHTML(totalPages) {
        if (totalPages \<lt;= 1) return '';
        
        let html = '\<lt;div class="pagination-controls"\>gt;';
        
        // Previous button
        if (this.currentPage \>gt; 1) {
            html += `\<lt;button class="pagination-btn" onclick="tableManager.goToPage(${this.currentPage - 1})"\>gt;‹\<lt;/button\>gt;`;
        }
        
        // Page numbers
        for (let i = 1; i \<lt;= totalPages; i++) {
            if (i === this.currentPage) {
                html += `\<lt;button class="pagination-btn active"\>gt;${i}\<lt;/button\>gt;`;
            } else {
                html += `\<lt;button class="pagination-btn" onclick="tableManager.goToPage(${i})"\>gt;${i}\<lt;/button\>gt;`;
            }
        }
        
        // Next button
        if (this.currentPage \<lt; totalPages) {
            html += `\<lt;button class="pagination-btn" onclick="tableManager.goToPage(${this.currentPage + 1})"\>gt;›\<lt;/button\>gt;`;
        }
        
        html += '\<lt;/div\>gt;';
        return html;
    }

    updateItemCount() {
        const totalElement = document.querySelector('.total-items');
        if (totalElement) {
            totalElement.textContent = `Total: ${this.filteredItems.length} items`;
        }
    }

    goToPage(page) {
        const totalPages = Math.ceil(this.filteredItems.length / this.pageSize);
        if (page \>gt;= 1 && page \<lt;= totalPages) {
            this.currentPage = page;
            this.updateDisplay();
        }
    }

    openSourceModal(filePath) {
        const modal = document.getElementById('source-modal');
        const modalTitle = document.getElementById('modal-title');
        const sourceCode = document.getElementById('source-code');
        
        if (!modal || !modalTitle || !sourceCode) return;
        
        modalTitle.textContent = filePath;
        sourceCode.innerHTML = '\<lt;div class="source-loading"\>gt;Loading source code...\<lt;/div\>gt;';
        
        modal.classList.add('show');
        
        // Simulate loading source code
        setTimeout(() =\>gt; {
            sourceCode.innerHTML = `\<lt;code\>gt;// Source code for ${filePath}
// This would typically load from the actual file
console.log('File: ${filePath}');

// Example content
function example() {
    return "This is example source code";
}

export default example;\<lt;/code\>gt;`;
        }, 500);
    }

    openColumnPicker() {
        const modal = document.getElementById('column-picker-modal');
        if (modal) {
            modal.classList.add('show');
        }
    }

    openGitHub() {
        // Would open GitHub file in new tab
        // Implementation would go here
    }

    closeModals() {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal =\>gt; {
            modal.classList.remove('show');
        });
    }

    toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }

    initializeTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
    }

    initializeColumnVisibility() {
        const checkboxes = document.querySelectorAll('.column-checkbox');
        checkboxes.forEach(checkbox =\>gt; {
            const columnName = checkbox.dataset.column;
            if (this.columnVisibility[columnName] !== undefined) {
                checkbox.checked = this.columnVisibility[columnName];
            }
            
            checkbox.addEventListener('change', (e) =\>gt; {
                this.toggleColumnVisibility(columnName, e.target.checked);
            });
        });
    }

    toggleColumnVisibility(columnName, visible) {
        this.columnVisibility[columnName] = visible;
        
        // Update table column visibility
        const table = document.querySelector('table');
        if (!table) return;
        
        const columnIndex = this.getColumnIndex(columnName);
        if (columnIndex === -1) return;
        
        // Hide/show header
        const headerCells = table.querySelectorAll('th');
        if (headerCells[columnIndex]) {
            headerCells[columnIndex].style.display = visible ? '' : 'none';
        }
        
        // Hide/show data cells
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row =\>gt; {
            if (row.cells[columnIndex]) {
                row.cells[columnIndex].style.display = visible ? '' : 'none';
            }
        });
    }

    getColumnIndex(columnName) {
        const columnMap = {
            'file-path': 0,
            'status': 1,
            'priority': 2,
            'expected-docs': 3,
            'effort': 4,
            'quality-issues': 5,
            'last-updated': 6
        };
        return columnMap[columnName] || -1;
    }

    focusSearch() {
        if (this.searchInput) {
            this.searchInput.focus();
        }
    }

    applyColumnVisibility() {
        const modal = document.getElementById('column-picker-modal');
        if (modal) {
            modal.classList.remove('show');
        }
    }

    resetColumnVisibility() {
        this.columnVisibility = {
            'file-path': true,
            'status': true,
            'priority': true,
            'expected-docs': true,
            'effort': false,
            'quality-issues': false,
            'last-updated': false
        };
        
        const checkboxes = document.querySelectorAll('.column-checkbox');
        checkboxes.forEach(checkbox =\>gt; {
            const columnName = checkbox.dataset.column;
            if (this.columnVisibility[columnName] !== undefined) {
                checkbox.checked = this.columnVisibility[columnName];
                this.toggleColumnVisibility(columnName, this.columnVisibility[columnName]);
            }
        });
    }
}

// Global functions for inline event handlers
function toggleTheme() {
    if (window.tableManager) {
        window.tableManager.toggleTheme();
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () =\>gt; {
    window.tableManager = new TableManager();
}); 