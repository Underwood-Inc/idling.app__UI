{% comment %}
Dynamic Navigation Generator - Liquid Template Version
This scans actual co-located markdown files via symlink and builds navigation from their frontmatter
Works in GitHub Pages safe mode by using Jekyll's built-in file access
{% endcomment %}

{% assign nav_items = '' | split: '' %}

{% comment %} 
Now that Jekyll can see the src/ files via symlink, scan all pages for navigation frontmatter
{% endcomment %}

{% comment %} Scan all pages Jekyll knows about {% endcomment %}
{% for page_item in site.pages %}
  {% comment %} Look for pages in the src directory with navigation frontmatter {% endcomment %}
  {% if page_item.path contains 'src/' and page_item.path contains '.md' %}
    {% if page_item.title and (page_item.parent or page_item.category or page_item.permalink) %}
      {% unless page_item.nav_exclude %}
        {% assign nav_item = '' | split: '' %}
        {% assign nav_item = nav_item | push: page_item.title %}
        {% assign nav_item = nav_item | push: page_item.url %}
        {% assign nav_item = nav_item | push: page_item.description %}
        {% assign nav_item = nav_item | push: page_item.parent %}
        {% assign nav_item = nav_item | push: page_item.category %}
        {% assign nav_item = nav_item | push: page_item.nav_order %}
        {% assign nav_items = nav_items | push: nav_item %}
      {% endunless %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %} Also check posts if any are in src {% endcomment %}
{% for post in site.posts %}
  {% if post.path contains 'src/' %}
    {% if post.title and (post.parent or post.category or post.permalink) %}
      {% unless post.nav_exclude %}
        {% assign nav_item = '' | split: '' %}
        {% assign nav_item = nav_item | push: post.title %}
        {% assign nav_item = nav_item | push: post.url %}
        {% assign nav_item = nav_item | push: post.description %}
        {% assign nav_item = nav_item | push: post.parent %}
        {% assign nav_item = nav_item | push: post.category %}
        {% assign nav_item = nav_item | push: post.nav_order %}
        {% assign nav_items = nav_items | push: nav_item %}
      {% endunless %}
    {% endif %}
  {% endif %}
{% endfor %}

{% comment %} Build navigation structure {% endcomment %}
{% assign auto_navigation = '' | split: '' %}
{% assign processed_parents = '' | split: '' %}

{% for item in nav_items %}
  {% assign title = item[0] %}
  {% assign url = item[1] %}
  {% assign description = item[2] %}
  {% assign parent = item[3] %}
  {% assign category = item[4] %}
  {% assign nav_order = item[5] | default: 999 %}
  
  {% assign parent_key = parent | default: category | default: 'root' %}
  
  {% unless processed_parents contains parent_key %}
    {% assign processed_parents = processed_parents | push: parent_key %}
    
    {% comment %} Find all items for this parent {% endcomment %}
    {% assign parent_items = '' | split: '' %}
    {% for check_item in nav_items %}
      {% assign check_parent = check_item[3] | default: check_item[4] | default: 'root' %}
      {% if check_parent == parent_key %}
        {% assign parent_items = parent_items | push: check_item %}
      {% endif %}
    {% endfor %}
    
    {% if parent_key == 'root' %}
      {% comment %} Add root items directly {% endcomment %}
      {% for root_item in parent_items %}
        {% assign root_nav = '' | split: '' %}
        {% assign root_nav = root_nav | push: root_item[0] %}
        {% assign root_nav = root_nav | push: root_item[1] %}
        {% assign root_nav = root_nav | push: root_item[2] %}
        {% assign auto_navigation = auto_navigation | push: root_nav %}
      {% endfor %}
    {% else %}
      {% comment %} Create parent with subnav {% endcomment %}
      {% assign parent_nav = '' | split: '' %}
      {% assign parent_nav = parent_nav | push: parent_key %}
      {% assign parent_nav = parent_nav | push: ('/' | append: parent_key | downcase | replace: ' ', '-' | append: '/') %}
      {% assign parent_nav = parent_nav | push: (parent_key | append: ' documentation') %}
      {% assign parent_nav = parent_nav | push: parent_items %}
      {% assign auto_navigation = auto_navigation | push: parent_nav %}
    {% endif %}
  {% endunless %}
{% endfor %}

<!-- DEBUG: Generated navigation from {{ nav_items.size }} co-located markdown files into {{ auto_navigation.size }} groups -->
<!-- Available as 'auto_navigation' variable for templates --> 
 