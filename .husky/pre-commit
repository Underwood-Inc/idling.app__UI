#!/bin/bash
# Comprehensive pre-commit hook for documentation and coverage
echo "ğŸš€ Running comprehensive pre-commit checks..."

# Source common environment setup
. "$(dirname "$0")/_/setup-env.sh"

# Ensure we're in the correct directory
cd "$(dirname "$0")/.."

# Check if this is a merge commit (skip heavy processing for merges)
if git rev-parse -q --verify MERGE_HEAD >/dev/null; then
  echo "ğŸ“ Merge commit detected - skipping documentation coverage checks"
  exit 0
fi

# Check if we have any staged changes to source files
STAGED_SOURCE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' | grep '^src/' || true)

if [ -z "$STAGED_SOURCE_FILES" ]; then
  echo "ğŸ“ No source files staged - skipping documentation coverage checks"
  exit 0
fi

echo "ğŸ“Š Found staged source files - running documentation coverage checks..."

# Create temporary directory for reports
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

# 1. Build Jekyll documentation locally (if bundle is available)
echo "ğŸ—ï¸ Checking Jekyll documentation build..."
cd DOCS
if command -v bundle >/dev/null 2>&1; then
  if bundle exec jekyll build --destination "$TEMP_DIR/docs_build" >/dev/null 2>&1; then
    echo "âœ… Jekyll documentation built successfully"
  else
    echo "âš ï¸ Jekyll documentation build failed (non-blocking)"
    echo "ğŸ”§ Run 'cd DOCS && bundle exec jekyll build' to see detailed errors"
    echo "ğŸš€ Continuing with documentation coverage checks..."
  fi
else
  echo "âš ï¸ Bundle not available - skipping Jekyll build check"
  echo "ğŸ’¡ Install Ruby and Bundle to enable Jekyll documentation validation"
fi
cd ..

# 2. Generate documentation coverage report
echo "ğŸ“š Generating documentation coverage report..."

total_files=0
documented_files=0
missing_files_count=0

# Check all TypeScript/JavaScript files in src/
find src -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" | grep -v -E '\.(test|spec)\.' | sort > "$TEMP_DIR/source_files.txt"

while IFS= read -r file; do
  # Skip test files, build files, and certain directories
  case "$file" in
    */__tests__/*|*/test/*|*/.next/*|*/node_modules/*|*.test.*|*.spec.*|*/build/*|*/dist/*)
      continue
      ;;
  esac
  
  total_files=$((total_files + 1))
  
  # Check for corresponding documentation
  base_name=$(basename "$file" | sed 's/\.[^.]*$//' | tr '[:upper:]' '[:lower:]')
  doc_found=false
  
  # Look for documentation in various locations
  for doc_pattern in "DOCS/components/${base_name}.md" "DOCS/api/${base_name}.md" "DOCS/utils/${base_name}.md" "DOCS/hooks/${base_name}.md" "DOCS/${file%.*}.md"; do
    if [ -f "$doc_pattern" ] && ! grep -q "Documentation Needed.*This file was automatically generated" "$doc_pattern" 2>/dev/null; then
      documented_files=$((documented_files + 1))
      doc_found=true
      break
    fi
  done
  
  if [ "$doc_found" = false ]; then
    missing_files_count=$((missing_files_count + 1))
    echo "Missing: $file" >> "$TEMP_DIR/missing_files.txt"
  fi
done < "$TEMP_DIR/source_files.txt"

# Calculate coverage
if [ $total_files -eq 0 ]; then
  DOC_COVERAGE=100
else
  DOC_COVERAGE=$((documented_files * 100 / total_files))
fi

echo "ğŸ“Š Documentation Coverage: ${DOC_COVERAGE}% (${documented_files}/${total_files} files)"

# 3. Update documentation coverage badges
echo "ğŸ¨ Updating documentation coverage badges..."

# Determine badge color
if [ $DOC_COVERAGE -ge 90 ]; then
  DOC_COLOR="brightgreen"
elif [ $DOC_COVERAGE -ge 75 ]; then
  DOC_COLOR="green"
elif [ $DOC_COVERAGE -ge 60 ]; then
  DOC_COLOR="yellow"
elif [ $DOC_COVERAGE -ge 40 ]; then
  DOC_COLOR="orange"
else
  DOC_COLOR="red"
fi

# Generate badge URLs
DOC_BADGE_URL="https://img.shields.io/badge/Documentation%20Coverage-${DOC_COVERAGE}%25-${DOC_COLOR}?style=flat&logo=gitbook&logoColor=white"

# Update README.md badge
if [ -f "README.md" ]; then
  # Look for existing documentation coverage badge and replace it
  if grep -q "Documentation%20Coverage" README.md; then
    sed -i.bak "s|https://img\.shields\.io/badge/Documentation%20Coverage-[0-9]*%25-[a-z]*?[^)]*|${DOC_BADGE_URL}|g" README.md
    rm -f README.md.bak
    echo "âœ… Updated documentation badge in README.md"
  else
    echo "âš ï¸ No existing documentation badge found in README.md"
  fi
fi

# Update Jekyll documentation badge include
JEKYLL_BADGE_DIR="DOCS/_includes"
mkdir -p "$JEKYLL_BADGE_DIR"

cat > "$JEKYLL_BADGE_DIR/documentation-coverage-badge.html" << 'EOF'
<!-- Documentation Coverage Badge - Auto-generated by pre-commit hook -->
<a href="{{ site.baseurl }}/testing/docker-e2e-setup" title="Documentation Coverage">
  <img src="DOC_BADGE_URL_PLACEHOLDER" alt="Documentation Coverage DOC_COVERAGE_PLACEHOLDER%" />
</a>
EOF

# Replace placeholders
sed -i "s|DOC_BADGE_URL_PLACEHOLDER|${DOC_BADGE_URL}|g" "$JEKYLL_BADGE_DIR/documentation-coverage-badge.html"
sed -i "s|DOC_COVERAGE_PLACEHOLDER|${DOC_COVERAGE}|g" "$JEKYLL_BADGE_DIR/documentation-coverage-badge.html"

echo "âœ… Updated Jekyll documentation badge include"

# Update centralized badge file
BADGE_DIR="DOCS/badges"
mkdir -p "$BADGE_DIR"

cat > "$BADGE_DIR/documentation-coverage.md" << 'EOF'
---
layout: default
title: Documentation Coverage Badge
description: Auto-generated documentation coverage badge
---

# Documentation Coverage Badge

![Documentation Coverage](DOC_BADGE_URL_PLACEHOLDER)

**Current Coverage:** DOC_COVERAGE_PLACEHOLDER% (DOCUMENTED_FILES_PLACEHOLDER/TOTAL_FILES_PLACEHOLDER files)

*Last updated: DATE_PLACEHOLDER*

## Badge URL

```
DOC_BADGE_URL_PLACEHOLDER
```

## Usage in Markdown

```markdown
![Documentation Coverage](DOC_BADGE_URL_PLACEHOLDER)
```

## Usage in HTML

```html
<img src="DOC_BADGE_URL_PLACEHOLDER" alt="Documentation Coverage DOC_COVERAGE_PLACEHOLDER%" />
```

---
*This file is automatically updated by the pre-commit hook*
EOF

# Replace placeholders
sed -i "s|DOC_BADGE_URL_PLACEHOLDER|${DOC_BADGE_URL}|g" "$BADGE_DIR/documentation-coverage.md"
sed -i "s|DOC_COVERAGE_PLACEHOLDER|${DOC_COVERAGE}|g" "$BADGE_DIR/documentation-coverage.md"
sed -i "s|DOCUMENTED_FILES_PLACEHOLDER|${documented_files}|g" "$BADGE_DIR/documentation-coverage.md"
sed -i "s|TOTAL_FILES_PLACEHOLDER|${total_files}|g" "$BADGE_DIR/documentation-coverage.md"
sed -i "s|DATE_PLACEHOLDER|$(date)|g" "$BADGE_DIR/documentation-coverage.md"

echo "âœ… Updated centralized documentation badge file"

# 4. Check if coverage meets minimum threshold
MIN_COVERAGE=75
if [ $DOC_COVERAGE -lt $MIN_COVERAGE ]; then
  echo "âš ï¸ Warning: Documentation coverage (${DOC_COVERAGE}%) is below minimum threshold (${MIN_COVERAGE}%)"
  echo "ğŸ“ Missing documentation for ${missing_files_count} files:"
  if [ -f "$TEMP_DIR/missing_files.txt" ]; then
    head -10 "$TEMP_DIR/missing_files.txt" | sed 's/^Missing: /   - /'
    if [ $missing_files_count -gt 10 ]; then
      echo "   ... and $((missing_files_count - 10)) more files"
    fi
  fi
  echo ""
  echo "ğŸ’¡ Consider creating documentation files in the DOCS/ directory"
  echo "   Example: For src/components/Button.tsx â†’ create DOCS/components/button.md"
  echo ""
  echo "ğŸš€ Proceeding with commit (coverage check is informational)"
fi

# 5. Stage updated badge files
BADGE_FILES_UPDATED=false

if [ -f "README.md" ] && git diff --quiet README.md; then
  : # No changes to README.md
elif [ -f "README.md" ]; then
  git add README.md
  BADGE_FILES_UPDATED=true
  echo "ğŸ“ Staged updated README.md"
fi

if [ -f "$JEKYLL_BADGE_DIR/documentation-coverage-badge.html" ]; then
  git add "$JEKYLL_BADGE_DIR/documentation-coverage-badge.html"
  BADGE_FILES_UPDATED=true
  echo "ğŸ“ Staged updated Jekyll badge include"
fi

if [ -f "$BADGE_DIR/documentation-coverage.md" ]; then
  git add "$BADGE_DIR/documentation-coverage.md"
  BADGE_FILES_UPDATED=true
  echo "ğŸ“ Staged updated centralized badge file"
fi

if [ "$BADGE_FILES_UPDATED" = true ]; then
  echo "âœ… Documentation badges updated and staged for commit"
else
  echo "ğŸ“ No badge files needed updating"
fi

# 6. Final summary
echo ""
echo "ğŸ¯ Pre-commit Summary:"
echo "  ğŸ“‹ Jekyll documentation: $(command -v bundle >/dev/null 2>&1 && echo "Checked" || echo "Skipped (bundle not available)")"
echo "  ğŸ“Š Documentation coverage: ${DOC_COVERAGE}%"
echo "  ğŸ¨ Badges updated: $([ "$BADGE_FILES_UPDATED" = true ] && echo "Yes" || echo "No changes needed")"
echo "  ğŸ“ Files documented: ${documented_files}/${total_files}"

if [ $missing_files_count -gt 0 ]; then
  echo "  âš ï¸  Missing docs: ${missing_files_count} files"
else
  echo "  âœ… All files documented!"
fi

echo ""
echo "ğŸš€ Pre-commit checks completed successfully!"
exit 0
